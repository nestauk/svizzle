<script>
	import * as _ from 'lamb';
	import {isNotNil} from '@svizzle/utils';

	import {_yearRange} from 'stores/data';
	import {_timelineLayout as _layout} from 'stores/layout';
	import {_style} from 'stores/theme';
	import {shortenYear} from 'utils/format';
	import {makeURL} from 'utils/url';

	export let availableYears = null;
	export let height = null;
	export let hrefBase = ''; // relative to `document.baseURI`
	export let indicatorId = null;
	export let selectedYear = null;
	export let showLess = false;
	export let width;

	$: yearsY = availableYears.length > 0 ? $_layout.y2 : $_layout.ym;

	/* buttons */

	$: halfHeight = $_layout.height / 2;
	$: buttonY = halfHeight / 2;
	$: prevX = buttonY;
	$: nextX = buttonY + halfHeight + 0.25 * buttonY;
	$: yearsCenterX = (nextX + halfHeight + width) / 2;
	$: min = halfHeight / 3;
	$: max = 2 * min;
	$: med = halfHeight / 2;
	$: chevronLeftPath = `${max} ${min} ${min} ${med} ${max} ${max}`;
	$: chevronRightPath = `${min} ${min} ${max} ${med} ${min} ${max}`;
	$: selectedYearIndex = _.findIndex(availableYears, _.is(selectedYear));
	$: prevYear = availableYears[selectedYearIndex - 1];
	$: isPrevYearActive = isNotNil(prevYear);
	$: nextYear = availableYears[selectedYearIndex + 1];
	$: isNextYearActive = isNotNil(nextYear);
	$: hrefPrev = isPrevYearActive
		? makeURL(hrefBase, indicatorId, prevYear)
		: null;
	$: hrefNext = isNextYearActive
		? makeURL(hrefBase, indicatorId, nextYear)
		: null;
</script>

<div
	class='Timeline'
	style={$_style}
>
	{#if width && height && $_layout}
		<svg
			{width}
			{height}
		>
			<!-- buttons -->
			{#if selectedYear}

				<!-- prev -->
				<a href={hrefPrev}>
					<g
						transform='translate({prevX},{buttonY})'
						class:active={isPrevYearActive}
					>
						<rect
							height={halfHeight}
							width={halfHeight}
						/>
						<polyline points={chevronLeftPath} />
					</g>
				</a>

				<!-- next -->
				<a href={hrefNext}>
					<g
						transform='translate({nextX},{buttonY})'
						class:active={isNextYearActive}
					>
						<rect
							height={halfHeight}
							width={halfHeight}
						/>
						<polyline points={chevronRightPath} />
					</g>
				</a>
			{/if}

			{#if showLess && selectedYear}

				<text
					x={yearsCenterX}
					y={halfHeight}
				>{selectedYear}</text>

			{:else}

				<!-- dots -->

				{#if availableYears}
					<g transform='translate(0,{$_layout.y1})'>
						<line
							x1='{$_layout.scaleX(availableYears[0]) + $_layout.radius}'
							x2='{$_layout.scaleX(_.last(availableYears)) - $_layout.radius}'
						/>
						{#each availableYears as year}
							<a href={makeURL(hrefBase, indicatorId, year)}>
								<circle
									class:selected='{selectedYear && selectedYear === year}'
									cx='{$_layout.scaleX(year)}'
									r={$_layout.radius}
								/>
							</a>
						{/each}
					</g>
				{/if}

				<!-- labels -->

				{#if $_yearRange}
					{#each $_yearRange as year}
						<text
							font-size={$_layout.fontSize}
							x={$_layout.scaleX(year)}
							y={yearsY}
						>{$_layout.doShortenYears ? shortenYear(year): year}</text>
					{/each}
				{/if}

			{/if}
		</svg>
	{/if}
</div>

<style>
	.Timeline {
		height: 100%;
		user-select: none;
		width: 100%;
	}

	svg text {
		dominant-baseline: middle;
		fill: var(--colorRef);
		pointer-events: none;
		stroke: none;
		text-anchor: middle;
	}

	svg line {
		pointer-events: none;
		stroke-width: 0.75;
		stroke: var(--colorRef);
	}

	svg circle {
		cursor: pointer;
		fill-opacity: 1;
		fill: var(--colorWhite);
		stroke-width: 1.5;
		stroke: var(--colorRef);
	}
	svg circle.selected {
		fill: var(--colorSelected);
	}

	/* buttons */

	rect {
		fill: var(--colorWhite);
	}
	polyline {
		fill: none;
		pointer-events: none;
		stroke-width: 2;
	}

	rect, polyline {
		stroke: var(--colorRefLight);
	}
	.active {
		cursor: pointer;
	}
	.active rect,
	.active polyline {
		stroke: var(--colorRef);
	}
</style>
