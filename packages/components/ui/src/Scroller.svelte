<script>
	import {makeStyleVars} from '@svizzle/dom';
	import {color} from 'd3-color';

	import {setupResizeObserver} from './actions/resizeObserver.js';

	const defaultTheme = {
		bottomShadowGeometry: 'inset 0px -12px 13px -13px',
		shadowColor: 'lightgrey',
		topShadowGeometry: 'inset 0px 12px 13px -13px',
	};

	export let alignHorizontally = false;
	export let alignVertically = false;
	export let outerScrollTop = 0;
	export let scrollbarWidth = 0;
	export let theme;

	let hasBottomShadow;
	let hasTopShadow;
	let previousScrollTop = 0;
	let scroller;
	let shadowOpacityBottom = 1;
	let shadowOpacityTop = 1;
	let slotHeight;

	const {
		_writable: _scrollerSize,
		resizeObserver: observeScrollerSize
	} = setupResizeObserver();

	const {
		_writable: _slotSize,
		resizeObserver: observeSlotSize
	} = setupResizeObserver();

	const update = () => {
		const {
			offsetHeight,
			offsetWidth,
			scrollTop,
			scrollHeight,
			scrollWidth
		} = scroller;
		const scrollEnd = scrollTop + offsetHeight;
		const scrollBottom = scrollHeight - scrollEnd;

		hasTopShadow = scrollTop > 0;
		hasBottomShadow = scrollHeight > scrollEnd;
		shadowOpacityTop = scrollTop < 10 ? scrollTop / 10 : 1;
		shadowOpacityBottom = scrollBottom < 10
			? scrollBottom / 10
			: 1;
		scrollbarWidth = Math.max(offsetWidth - scrollWidth, 0);
		previousScrollTop = scrollTop;
		if (outerScrollTop !== scrollTop) {
			outerScrollTop = scrollTop;
		}
	};

	$: ({blockSize: slotHeight} = $_slotSize);
	$: scroller && $_scrollerSize && slotHeight && update();
	$: if (previousScrollTop !== outerScrollTop) {
		scroller.scroll({
			top: outerScrollTop,
			behavior: 'smooth'
		})
		// scroller.scrollTop = outerScrollTop;
	}
	$: theme = theme ? {...defaultTheme, ...theme} : defaultTheme;
	$: rgb = color(theme.shadowColor).rgb();
	$: bottomShadow = `${theme.bottomShadowGeometry} rgba(${rgb.r},${rgb.g},${rgb.b},${shadowOpacityBottom})`;
	$: topShadow = `${theme.topShadowGeometry} rgba(${rgb.r},${rgb.g},${rgb.b},${shadowOpacityTop})`;
	$: style = makeStyleVars({bottomShadow, topShadow});
</script>

<div
	{style}
	bind:this={scroller}
	class:alignedHorizontally={alignHorizontally}
	class:alignedVertically={alignVertically}
	class:shadowBottom={hasBottomShadow}
	class:shadowTop={hasTopShadow}
	class='Scroller'
	on:scroll={update}
	use:observeScrollerSize
>
	<div use:observeSlotSize>
		<slot />
	</div>
</div>

<style>
	.Scroller {
		height: 100%;
		overflow-x: hidden;
		overflow-y: auto;
		position: relative;
		width: 100%;
	}

	.alignedHorizontally {
		display: grid;
		justify-content: center;
	}
	.alignedVertically {
		align-items: center;
		display: grid;
	}

	.shadowTop {
		box-shadow: var(--topShadow);
	}
	.shadowBottom {
		box-shadow: var(--bottomShadow);
	}
	.shadowTop.shadowBottom {
		box-shadow:
			var(--topShadow),
			var(--bottomShadow);
	}
</style>
